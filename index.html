<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>บอร์ดข้อความสาธารณะ (แชร์ได้)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: linear-gradient(135deg, #0f2027 0%, #232a3b 100%);
      min-height: 100vh;
    }
    #toast {
      transition: opacity 0.5s, transform 0.5s;
      box-shadow: 0 0 24px 4px #22d3ee;
      background: linear-gradient(90deg, #0ea5e9 0%, #38bdf8 100%);
      color: #fff;
    }
    .hi-tech-glow {
      text-shadow: 0 0 8px #38bdf8, 0 0 16px #0ea5e9;
    }
    .fade-in {
      animation: fadeIn 0.7s cubic-bezier(0.4,0,0.2,1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .gradient-border {
      border: 2px solid #38bdf8;
      border-radius: 1rem;
      background: linear-gradient(120deg, #232a3b 80%, #0ea5e9 100%) padding-box,
                  linear-gradient(90deg, #38bdf8, #0ea5e9, #818cf8) border-box;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

  <div class="container mx-auto max-w-3xl p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8 py-8 rounded-2xl shadow-xl bg-gradient-to-r from-cyan-700 via-blue-900 to-indigo-900">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-300 hi-tech-glow">บอร์ดข้อความสาธารณะ</h1>
      <p class="text-gray-200 mt-2">โพสต์ข้อความเพื่อให้ทุกคนเห็นได้ทันที</p>
      <div class="mt-4 text-sm text-cyan-200">
        <span>ID บอร์ด: </span><span id="board-id-display" class="font-mono bg-gray-800 p-1 rounded shadow-inner"></span>
      </div>
    </header>

    <div class="bg-[#181f2a] dark:bg-[#181f2a] p-6 rounded-2xl shadow-2xl mb-8 gradient-border">
      <form id="message-form">
        <label for="title-input" class="block text-lg font-semibold mb-2 text-cyan-400">หัวข้อ/ชื่อไฟล์:</label>
        <input id="title-input" type="text" class="w-full p-3 mb-3 bg-[#232a3b] text-cyan-200 border border-cyan-700 focus:border-cyan-400 focus:ring-0 rounded-lg transition placeholder:text-cyan-700" placeholder="ใส่หัวข้อหรือชื่อไฟล์..." />
        <label for="message-input" class="block text-lg font-semibold mb-2 text-cyan-400">ข้อความของคุณ:</label>
        <textarea id="message-input" rows="4" class="w-full p-3 bg-[#232a3b] text-cyan-100 border border-cyan-700 focus:border-cyan-400 focus:ring-0 rounded-lg transition placeholder:text-cyan-700" placeholder="พิมพ์ข้อความที่นี่..."></textarea>
        <button type="submit" id="post-button" class="mt-4 w-full bg-gradient-to-r from-cyan-500 to-blue-700 hover:from-blue-600 hover:to-cyan-400 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-cyan-400">
          โพสต์ข้อความ
        </button>
      </form>
    </div>

    <div id="messages-container" class="space-y-4">
      <div id="loading-state" class="text-center py-10">
        <p class="text-gray-500 dark:text-gray-400">กำลังโหลดข้อความ...</p>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-10">
    คัดลอกข้อความแล้ว!
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbD0PkshU9iNghvi-FCsV74PeR4aWzyQo",
      authDomain: "sent-9c549.firebaseapp.com",
      projectId: "sent-9c549",
      storageBucket: "sent-9c549.firebasestorage.app",
      messagingSenderId: "436570838998",
      appId: "1:436570838998:web:ec79c0496464ceabe33677",
      measurementId: "G-LF7KP2Z7RL"
    };

    const SHARED_BOARD_ID = 'my-shared-board-123';
    const appId = SHARED_BOARD_ID;

    let db, auth;
    let currentUserId = null;
    let messagesUnsubscribe = null;

    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const titleInput = document.getElementById('title-input');
    const messagesContainer = document.getElementById('messages-container');
    const loadingState = document.getElementById('loading-state');
    const toast = document.getElementById('toast');
    const boardIdDisplay = document.getElementById('board-id-display');

    async function main() {
      boardIdDisplay.textContent = appId;

      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            currentUserId = user.uid;
            listenForMessages();
          } else {
            await signInAnonymously(auth);
          }
        });

      } catch (error) {
        console.error("Error initializing Firebase:", error);
        loadingState.textContent = "เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์";
      }
    }

    function listenForMessages() {
      if (messagesUnsubscribe) messagesUnsubscribe();

      const messagesCollectionPath = `/artifacts/${appId}/public/data/messages`;
      const q = query(collection(db, messagesCollectionPath));

      messagesUnsubscribe = onSnapshot(q, (querySnapshot) => {
        loadingState.style.display = 'none';
        const messages = [];
        querySnapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });

        messages.sort((a, b) => {
          const timeA = a.timestamp?.toMillis() || 0;
          const timeB = b.timestamp?.toMillis() || 0;
          return timeB - timeA;
        });

        renderMessages(messages);
      }, (error) => {
        console.error("Error listening to messages:", error);
        messagesContainer.innerHTML = `<p class="text-center text-red-500">ไม่สามารถโหลดข้อความได้</p>`;
      });
    }

    async function postMessage(text, title) {
      if (!text.trim()) return;
      try {
        const messagesCollectionPath = `/artifacts/${appId}/public/data/messages`;
        await addDoc(collection(db, messagesCollectionPath), {
          text: text,
          title: title || '',
          timestamp: serverTimestamp(),
          authorId: currentUserId
        });
        messageInput.value = '';
        titleInput.value = '';
      } catch (error) {
        console.error("Error posting message: ", error);
        alert("เกิดข้อผิดพลาดในการส่งข้อความ");
      }
    }

    function renderMessages(messages) {
      messagesContainer.innerHTML = '';
      if (messages.length === 0) {
        messagesContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">ยังไม่มีข้อความ ลองโพสต์เป็นคนแรกสิ!</p>`;
        return;
      }

      messages.forEach(msg => {
        const messageElement = createMessageElement(msg);
        messagesContainer.appendChild(messageElement);
      });
    }

    function createMessageElement(msg) {
      const div = document.createElement('div');
      div.className = 'bg-[#181f2a] dark:bg-[#181f2a] p-5 rounded-xl shadow-2xl flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 fade-in gradient-border transition-transform duration-300 hover:scale-105 hover:shadow-cyan-400/50 group';

      // เพิ่มหัวข้อ
      if (msg.title && msg.title.trim()) {
        const titleElem = document.createElement('div');
        titleElem.className = 'font-bold text-cyan-400 hi-tech-glow mb-1 w-full text-lg tracking-wide group-hover:text-blue-400 transition';
        titleElem.textContent = msg.title;
        div.appendChild(titleElem);
      }

      const textContent = document.createElement('p');
      textContent.className = 'text-cyan-100 whitespace-pre-wrap flex-1 text-base';
      textContent.textContent = msg.text;

      const metaContainer = document.createElement('div');
      metaContainer.className = 'flex items-center gap-4 w-full sm:w-auto';

      const timestamp = document.createElement('span');
      timestamp.className = 'text-xs text-cyan-500 font-mono';
      timestamp.textContent = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString('th-TH') : 'กำลังส่ง...';

      const copyButton = document.createElement('button');
      copyButton.className = 'bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-blue-500 hover:to-cyan-400 text-white font-semibold py-1 px-4 rounded-full shadow-md transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-cyan-400 active:scale-95';
      copyButton.textContent = 'คัดลอก';
      copyButton.onclick = () => copyTextToClipboard(msg.text, copyButton);

      metaContainer.appendChild(timestamp);
      metaContainer.appendChild(copyButton);

      div.appendChild(textContent);
      div.appendChild(metaContainer);

      return div;
    }

    messageForm.addEventListener('submit', (e) => {
      e.preventDefault();
      postMessage(messageInput.value, titleInput.value);
    });

    function copyTextToClipboard(text, button) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showToast();
        button.textContent = 'คัดลอกแล้ว!';
        setTimeout(() => {
          button.textContent = 'คัดลอก';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy text: ', err);
      }
      document.body.removeChild(textArea);
    }

    function showToast() {
      toast.classList.remove('opacity-0', 'translate-y-10');
      toast.classList.add('opacity-100', 'translate-y-0');
      setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-y-0');
        toast.classList.add('opacity-0', 'translate-y-10');
      }, 2000);
    }

    main();
  </script>
</body>
</html>
